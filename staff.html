<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff — CentralHub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Lora:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink:#1c1c2e; --ink-2:#44445a; --ink-3:#8888a8;
      --paper:#f7f6f3; --paper-2:#efede8; --white:#ffffff;
      --border:#e0ddd6; --accent:#0891b2; --accent-dk:#0e7490;
      --shadow-sm:0 1px 4px rgba(28,28,46,.07);
      --shadow:0 3px 14px rgba(28,28,46,.10);
      --shadow-lg:0 10px 40px rgba(28,28,46,.16);
      --radius:10px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--paper); color: var(--ink); min-height: 100vh; }

    /* NAV */
    .top-nav { position: sticky; top: 0; z-index: 100; height: 62px; padding: 0 28px; display: flex; align-items: center; gap: 28px; background: rgba(5,5,16,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.08); }
    .nav-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; flex-shrink: 0; }
    .nav-brand-name { font-size: 1.05rem; font-weight: 600; color: #fff; letter-spacing: -0.02em; }
    .nav-links { display: flex; align-items: center; gap: 2px; flex: 1; }
    .nav-link { font-size: 0.875rem; font-weight: 500; color: rgba(255,255,255,0.6); text-decoration: none; padding: 6px 12px; border-radius: 6px; transition: color 0.2s, background 0.2s; }
    .nav-link:hover { color: #fff; background: rgba(255,255,255,0.07); }
    .nav-link.active { color: #fff; background: rgba(255,255,255,0.10); }
    .nav-auth { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    .nav-user-name { font-size: 0.875rem; color: rgba(255,255,255,0.65); }
    .nav-avatar { width: 34px; height: 34px; border-radius: 50%; background: linear-gradient(135deg,#7c3aed,#0891b2); display: flex; align-items: center; justify-content: center; font-size: 0.78rem; font-weight: 700; color: #fff; flex-shrink: 0; user-select: none; }
    .btn-logout { font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 500; color: rgba(255,255,255,0.48); background: none; border: 1px solid rgba(255,255,255,0.12); border-radius: 6px; padding: 5px 12px; cursor: pointer; transition: color 0.2s, border-color 0.2s; }
    .btn-logout:hover { color: #fff; border-color: rgba(255,255,255,0.28); }

    /* PAGE */
    .page-content { padding: 28px 32px; max-width: 1200px; margin: 0 auto; }

    /* TOOLBAR */
    .toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
    .toolbar-search { flex: 1; min-width: 200px; position: relative; }
    .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--ink-3); pointer-events: none; }
    .search-input { width: 100%; padding: 9px 12px 9px 34px; border: 1px solid var(--border); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.875rem; color: var(--ink); background: var(--white); outline: none; box-shadow: var(--shadow-sm); transition: border-color 0.2s; }
    .search-input:focus { border-color: var(--accent); }
    .search-input::placeholder { color: var(--ink-3); }
    .filter-select { padding: 9px 12px; border: 1px solid var(--border); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.875rem; color: var(--ink); background: var(--white); outline: none; box-shadow: var(--shadow-sm); cursor: pointer; }
    .filter-select:focus { border-color: var(--accent); }
    .staff-count { font-size: 0.85rem; color: var(--ink-3); padding: 0 4px; }
    .btn-add { display: none; align-items: center; gap: 6px; padding: 9px 16px; background: linear-gradient(135deg,#7c3aed,#0891b2); color: #fff; font-family: 'DM Sans', sans-serif; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: opacity 0.2s, transform 0.15s; flex-shrink: 0; }
    .btn-add:hover { opacity: 0.9; transform: translateY(-1px); }

    /* TABLE */
    .table-wrap { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-sm); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--paper); border-bottom: 1px solid var(--border); }
    th { padding: 11px 16px; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.07em; white-space: nowrap; cursor: pointer; user-select: none; }
    th:hover { color: var(--ink-2); }
    th.sorted { color: var(--accent); }
    td { padding: 13px 16px; font-size: 0.875rem; color: var(--ink); border-bottom: 1px solid var(--paper-2); vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--paper); }
    .staff-avatar { width: 34px; height: 34px; border-radius: 50%; background: linear-gradient(135deg,#7c3aed,#0891b2); display: flex; align-items: center; justify-content: center; font-size: 0.72rem; font-weight: 700; color: #fff; flex-shrink: 0; }
    .staff-name-cell { display: flex; align-items: center; gap: 10px; }
    .staff-name { font-weight: 500; }
    .staff-email { font-size: 0.78rem; color: var(--ink-3); font-family: 'DM Mono', monospace; }
    .td-actions { display: flex; gap: 6px; }
    .btn-action { background: none; border: 1px solid var(--border); border-radius: 6px; padding: 4px 10px; font-size: 0.78rem; font-family: 'DM Sans', sans-serif; color: var(--ink-2); cursor: pointer; transition: color 0.2s, border-color 0.2s; }
    .btn-action:hover { color: var(--ink); border-color: #bbb; }
    .btn-action-del { color: var(--ink-3); }
    .btn-action-del:hover { color: #dc2626; border-color: #fca5a5; background: #fee2e2; }

    /* BADGES */
    .badge { display: inline-flex; align-items: center; font-size: 0.7rem; font-weight: 600; padding: 2px 8px; border-radius: 20px; }
    .badge-teal   { background: #e0f2fe; color: #0e7490; }
    .badge-amber  { background: #fef3c7; color: #92400e; }
    .badge-red    { background: #fee2e2; color: #991b1b; }
    .badge-violet { background: #ede9fe; color: #5b21b6; }
    .badge-green  { background: #d1fae5; color: #065f46; }

    /* EMPTY */
    .empty-row td { text-align: center; padding: 48px; color: var(--ink-3); font-size: 0.875rem; }

    /* SKELETON */
    .skel { background: linear-gradient(90deg,var(--paper-2) 25%,var(--paper) 50%,var(--paper-2) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; display: inline-block; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* DRAWER */
    .drawer-overlay { display: none; position: fixed; inset: 0; background: rgba(28,28,46,0.45); z-index: 200; }
    .drawer-overlay.open { display: block; }
    .drawer { position: fixed; top: 0; right: 0; height: 100%; width: 400px; max-width: 92vw; background: var(--white); box-shadow: var(--shadow-lg); display: flex; flex-direction: column; z-index: 201; transform: translateX(100%); transition: transform 0.3s ease; }
    .drawer-overlay.open .drawer { transform: translateX(0); }
    .drawer-head { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 16px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .drawer-head h3 { font-size: 1rem; font-weight: 600; }
    .drawer-close { background: none; border: none; font-size: 1.4rem; color: var(--ink-3); cursor: pointer; padding: 0; line-height: 1; }
    .drawer-close:hover { color: var(--ink); }
    .drawer-body { flex: 1; overflow-y: auto; padding: 20px 24px; display: flex; flex-direction: column; gap: 14px; }
    .drawer-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; flex-shrink: 0; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-label { font-size: 0.82rem; font-weight: 500; color: var(--ink-2); }
    .form-input, .form-select { padding: 9px 12px; border: 1px solid var(--border); border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; color: var(--ink); background: var(--paper); outline: none; transition: border-color 0.2s; }
    .form-input:focus, .form-select:focus { border-color: var(--accent); background: var(--white); }
    .form-input::placeholder { color: var(--ink-3); }
    .btn-cancel { padding: 9px 18px; background: none; border: 1px solid var(--border); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.875rem; color: var(--ink-2); cursor: pointer; }
    .btn-cancel:hover { border-color: #bbb; }
    .btn-save { padding: 9px 20px; background: linear-gradient(135deg,#7c3aed,#0891b2); color: #fff; border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
    .btn-save:hover { opacity: 0.88; }
    .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }
    .drawer-error { font-size: 0.82rem; color: #dc2626; background: #fee2e2; border-radius: 6px; padding: 8px 12px; display: none; }
    .drawer-error.visible { display: block; }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .page-content { padding: 20px 16px; }
      .nav-links { display: none; }
      table { font-size: 0.82rem; }
      th, td { padding: 10px 10px; }
      .staff-email { display: none; }
    }
    @media (max-width: 560px) {
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-search { min-width: 0; }
    }
  </style>
</head>
<body>

<nav class="top-nav" aria-label="Main navigation">
  <a href="index.html" class="nav-brand">
    <svg width="30" height="30" viewBox="0 0 32 32" fill="none" aria-hidden="true">
      <circle cx="16" cy="16" r="6" fill="#8b5cf6"/>
      <circle cx="16" cy="4.5" r="3.2" fill="#6d28d9" opacity="0.9"/>
      <circle cx="27.5" cy="22.5" r="3.2" fill="#6d28d9" opacity="0.9"/>
      <circle cx="4.5" cy="22.5" r="3.2" fill="#6d28d9" opacity="0.9"/>
      <line x1="16" y1="10" x2="16" y2="7.7" stroke="#c4b5fd" stroke-width="1.6" stroke-linecap="round"/>
      <line x1="21" y1="19.4" x2="24.7" y2="21.2" stroke="#c4b5fd" stroke-width="1.6" stroke-linecap="round"/>
      <line x1="11" y1="19.4" x2="7.3" y2="21.2" stroke="#c4b5fd" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
    <span class="nav-brand-name">CentralHub</span>
  </a>
  <div class="nav-links">
    <a href="index.html" class="nav-link">Dashboard</a>
    <a href="schools.html" class="nav-link">Schools</a>
    <a href="staff.html" class="nav-link active">Staff</a>
    <a href="announcements.html" class="nav-link">Announcements</a>
    <a href="messageboard.html" class="nav-link">Message Board</a>
  </div>
  <div class="nav-auth">
    <span class="nav-user-name"></span>
    <div class="nav-avatar" id="navAvatar" aria-hidden="true"></div>
    <button class="btn-logout" id="logoutBtn">Sign out</button>
  </div>
</nav>

<div class="page-content">
  <!-- TOOLBAR -->
  <div class="toolbar">
    <div class="toolbar-search">
      <svg class="search-icon" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input class="search-input" id="searchInput" type="search" placeholder="Search by name, email, school…" aria-label="Search staff">
    </div>
    <select class="filter-select" id="schoolFilter" aria-label="Filter by school"><option value="">All schools</option></select>
    <select class="filter-select" id="roleFilter" aria-label="Filter by role">
      <option value="">All roles</option>
      <option value="teacher">Teacher</option>
      <option value="admin">Admin</option>
      <option value="staff">Staff</option>
      <option value="coordinator">Coordinator</option>
    </select>
    <select class="filter-select" id="statusFilter" aria-label="Filter by status">
      <option value="">All statuses</option>
      <option value="active">Active</option>
      <option value="pending">Pending</option>
      <option value="inactive">Inactive</option>
    </select>
    <span class="staff-count" id="staffCount"></span>
    <button class="btn-add" id="addStaffBtn" aria-label="Add staff member">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Staff
    </button>
  </div>

  <!-- TABLE -->
  <div class="table-wrap">
    <table aria-label="Staff directory">
      <thead>
        <tr>
          <th data-sort="name">Name ↕</th>
          <th data-sort="role">Role ↕</th>
          <th data-sort="school">School ↕</th>
          <th>Department</th>
          <th data-sort="status">Status ↕</th>
          <th id="actionsHeader" style="display:none">Actions</th>
        </tr>
      </thead>
      <tbody id="staffBody">
        <tr><td colspan="6" style="padding:48px;text-align:center;color:var(--ink-3)">
          <span class="skel" style="height:16px;width:60%;display:block;margin:auto"></span>
        </td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ADD / EDIT DRAWER -->
<div class="drawer-overlay" id="drawerOverlay" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
  <div class="drawer">
    <div class="drawer-head">
      <h3 id="drawerTitle">Add Staff Member</h3>
      <button class="drawer-close" id="drawerClose" aria-label="Close">&#215;</button>
    </div>
    <div class="drawer-body">
      <div class="drawer-error" id="drawerError" role="alert"></div>
      <div class="form-group">
        <label class="form-label" for="fieldName">Full Name *</label>
        <input class="form-input" id="fieldName" placeholder="e.g. Budi Santoso">
      </div>
      <div class="form-group">
        <label class="form-label" for="fieldEmail">Email *</label>
        <input class="form-input" type="email" id="fieldEmail" placeholder="budi@eduversal.org">
      </div>
      <div class="form-group">
        <label class="form-label" for="fieldSchool">School *</label>
        <select class="form-select" id="fieldSchool">
          <option value="">Select school…</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="fieldRole">Role *</label>
        <select class="form-select" id="fieldRole">
          <option value="teacher">Teacher</option>
          <option value="admin">Admin</option>
          <option value="staff">Staff</option>
          <option value="coordinator">Coordinator</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="fieldDept">Department</label>
        <input class="form-input" id="fieldDept" placeholder="e.g. Mathematics, Science…">
      </div>
      <div class="form-group">
        <label class="form-label" for="fieldStatus">Status</label>
        <select class="form-select" id="fieldStatus">
          <option value="active">Active</option>
          <option value="pending">Pending</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
    </div>
    <div class="drawer-footer">
      <button class="btn-cancel" id="cancelBtn">Cancel</button>
      <button class="btn-save"   id="saveBtn">Save</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="auth-guard.js"></script>
<script>
  let allStaff    = [];
  let allSchools  = [];
  let isAdmin     = false;
  let editingId   = null;
  let sortKey     = 'name';
  let sortAsc     = true;

  const ROLE_BADGE = {
    teacher:     '<span class="badge badge-teal">Teacher</span>',
    admin:       '<span class="badge badge-violet">Admin</span>',
    staff:       '<span class="badge badge-amber">Staff</span>',
    coordinator: '<span class="badge badge-green">Coordinator</span>',
  };
  const STATUS_BADGE = {
    active:   '<span class="badge badge-teal">Active</span>',
    pending:  '<span class="badge badge-amber">Pending</span>',
    inactive: '<span class="badge badge-red">Inactive</span>',
  };

  document.addEventListener('authReady', async ({ detail: { profile } }) => {
    isAdmin = profile.role === 'admin';
    if (isAdmin) {
      document.getElementById('addStaffBtn').style.display = 'flex';
      document.getElementById('actionsHeader').style.display = '';
    }
    await Promise.all([loadSchools(), loadStaff()]);
    bindEvents();
  });

  async function loadSchools() {
    const snap = await db.collection('schools').orderBy('name').get();
    allSchools = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    // Populate school filter + drawer select
    const options = allSchools.map(s => `<option value="${esc(s.name)}">${esc(s.name)}</option>`).join('');
    document.getElementById('schoolFilter').insertAdjacentHTML('beforeend', options);
    document.getElementById('fieldSchool').insertAdjacentHTML('beforeend', options);
  }

  async function loadStaff() {
    try {
      const snap = await db.collection('staff').get();
      allStaff = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      applyFilters();
    } catch(e) {
      document.getElementById('staffBody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--ink-3)">Could not load staff data.</td></tr>';
    }
  }

  function bindEvents() {
    ['searchInput','schoolFilter','roleFilter','statusFilter'].forEach(id =>
      document.getElementById(id).addEventListener('input', applyFilters));
    document.querySelectorAll('th[data-sort]').forEach(th =>
      th.addEventListener('click', () => {
        const k = th.dataset.sort;
        sortAsc = sortKey === k ? !sortAsc : true;
        sortKey = k;
        document.querySelectorAll('th[data-sort]').forEach(t => t.classList.remove('sorted'));
        th.classList.add('sorted');
        applyFilters();
      })
    );
    document.getElementById('addStaffBtn').addEventListener('click', openAddDrawer);
    document.getElementById('drawerClose').addEventListener('click', closeDrawer);
    document.getElementById('cancelBtn').addEventListener('click', closeDrawer);
    document.getElementById('drawerOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeDrawer(); });
    document.getElementById('saveBtn').addEventListener('click', saveStaff);
  }

  function applyFilters() {
    const q  = document.getElementById('searchInput').value.toLowerCase();
    const sc = document.getElementById('schoolFilter').value;
    const ro = document.getElementById('roleFilter').value;
    const st = document.getElementById('statusFilter').value;
    let list = allStaff.filter(s =>
      (!q  || s.name?.toLowerCase().includes(q) || s.email?.toLowerCase().includes(q) || s.school?.toLowerCase().includes(q)) &&
      (!sc || s.school === sc) &&
      (!ro || s.role   === ro) &&
      (!st || s.status === st)
    ).sort((a, b) => {
      const va = (a[sortKey] || '').toLowerCase();
      const vb = (b[sortKey] || '').toLowerCase();
      return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
    });
    document.getElementById('staffCount').textContent = `${list.length} member${list.length !== 1 ? 's' : ''}`;
    renderTable(list);
  }

  function renderTable(list) {
    const body = document.getElementById('staffBody');
    if (!list.length) {
      body.innerHTML = '<tr class="empty-row"><td colspan="6">No staff members match your filters.</td></tr>';
      return;
    }
    body.innerHTML = list.map(s => {
      const initials = s.name ? s.name.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase() : '??';
      const actions  = isAdmin ? `
        <td><div class="td-actions">
          <button class="btn-action" onclick="editStaff('${s.id}')">Edit</button>
          <button class="btn-action btn-action-del" onclick="deleteStaff('${s.id}')">Delete</button>
        </div></td>` : '';
      return `
        <tr>
          <td>
            <div class="staff-name-cell">
              <div class="staff-avatar" aria-hidden="true">${initials}</div>
              <div>
                <p class="staff-name">${esc(s.name||'—')}</p>
                <p class="staff-email">${esc(s.email||'')}</p>
              </div>
            </div>
          </td>
          <td>${ROLE_BADGE[s.role] || esc(s.role||'—')}</td>
          <td>${esc(s.school||'—')}</td>
          <td>${esc(s.department||'—')}</td>
          <td>${STATUS_BADGE[s.status] || esc(s.status||'—')}</td>
          ${actions}
        </tr>`;
    }).join('');
  }

  // ===== Delete =====
  async function deleteStaff(id) {
    if (!confirm('Remove this staff member? This cannot be undone.')) return;
    await db.collection('staff').doc(id).delete();
    allStaff = allStaff.filter(s => s.id !== id);
    applyFilters();
  }

  // ===== Drawer =====
  function openAddDrawer() {
    editingId = null;
    document.getElementById('drawerTitle').textContent = 'Add Staff Member';
    ['fieldName','fieldEmail','fieldDept'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('fieldSchool').value = '';
    document.getElementById('fieldRole').value   = 'teacher';
    document.getElementById('fieldStatus').value = 'active';
    hideErr();
    document.getElementById('drawerOverlay').classList.add('open');
    document.getElementById('fieldName').focus();
  }

  function editStaff(id) {
    const s = allStaff.find(x => x.id === id);
    if (!s) return;
    editingId = id;
    document.getElementById('drawerTitle').textContent  = 'Edit Staff Member';
    document.getElementById('fieldName').value   = s.name       || '';
    document.getElementById('fieldEmail').value  = s.email      || '';
    document.getElementById('fieldSchool').value = s.school     || '';
    document.getElementById('fieldRole').value   = s.role       || 'teacher';
    document.getElementById('fieldDept').value   = s.department || '';
    document.getElementById('fieldStatus').value = s.status     || 'active';
    hideErr();
    document.getElementById('drawerOverlay').classList.add('open');
  }

  function closeDrawer() { document.getElementById('drawerOverlay').classList.remove('open'); }
  function showErr(m)    { const e=document.getElementById('drawerError'); e.textContent=m; e.classList.add('visible'); }
  function hideErr()     { document.getElementById('drawerError').classList.remove('visible'); }

  async function saveStaff() {
    const name   = document.getElementById('fieldName').value.trim();
    const email  = document.getElementById('fieldEmail').value.trim();
    const school = document.getElementById('fieldSchool').value;
    if (!name || !email || !school) { showErr('Name, email, and school are required.'); return; }

    const data = {
      name, email, school,
      role:       document.getElementById('fieldRole').value,
      department: document.getElementById('fieldDept').value.trim(),
      status:     document.getElementById('fieldStatus').value,
    };
    const btn = document.getElementById('saveBtn');
    btn.disabled = true; btn.textContent = 'Saving…';
    try {
      if (editingId) {
        await db.collection('staff').doc(editingId).update(data);
      } else {
        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        const ref = await db.collection('staff').add(data);
        data.id = ref.id;
      }
      closeDrawer();
      await loadStaff();
    } catch(e) {
      showErr(e.message);
    } finally {
      btn.disabled = false; btn.textContent = 'Save';
    }
  }

  function esc(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
</script>
</body>
</html>
