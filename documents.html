<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Documents — CentralHub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Lora:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #1c1c2e; --ink-2: #44445a; --ink-3: #8888a8;
      --paper: #f7f6f3; --paper-2: #efede8; --white: #ffffff;
      --border: #e0ddd6; --accent: #0891b2; --accent-dk: #0e7490;
      --shadow-sm: 0 1px 4px rgba(28,28,46,.07);
      --shadow: 0 3px 14px rgba(28,28,46,.10);
      --shadow-lg: 0 10px 40px rgba(28,28,46,.16);
      --radius: 10px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--paper); color: var(--ink); min-height: 100vh; }

    /* NAV */
    .top-nav { position: sticky; top: 0; z-index: 100; height: 62px; padding: 0 28px; display: flex; align-items: center; gap: 28px; background: rgba(5,5,16,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.08); }
    .nav-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; flex-shrink: 0; }
    .nav-brand-name { font-size: 1.05rem; font-weight: 600; color: #fff; letter-spacing: -0.02em; }
    .nav-links { display: flex; align-items: center; gap: 2px; flex: 1; }
    .nav-link { font-size: 0.875rem; font-weight: 500; color: rgba(255,255,255,0.6); text-decoration: none; padding: 6px 12px; border-radius: 6px; transition: color 0.2s, background 0.2s; }
    .nav-link:hover { color: #fff; background: rgba(255,255,255,0.07); }
    .nav-link.active { color: #fff; background: rgba(255,255,255,0.10); }
    .nav-auth { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    .nav-user-name { font-size: 0.875rem; color: rgba(255,255,255,0.65); }
    .nav-avatar { width: 34px; height: 34px; border-radius: 50%; background: linear-gradient(135deg,#7c3aed,#0891b2); display: flex; align-items: center; justify-content: center; font-size: 0.78rem; font-weight: 700; color: #fff; flex-shrink: 0; user-select: none; }
    .btn-logout { font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 500; color: rgba(255,255,255,0.48); background: none; border: 1px solid rgba(255,255,255,0.12); border-radius: 6px; padding: 5px 12px; cursor: pointer; transition: color 0.2s, border-color 0.2s; }
    .btn-logout:hover { color: #fff; border-color: rgba(255,255,255,0.28); }

    /* PAGE LAYOUT */
    .page-layout { display: grid; grid-template-columns: 220px 1fr; min-height: calc(100vh - 62px); }

    /* SIDEBAR */
    .sidebar { background: var(--white); border-right: 1px solid var(--border); padding: 24px 16px; position: sticky; top: 62px; height: calc(100vh - 62px); overflow-y: auto; }
    .sidebar-title { font-size: 0.7rem; font-weight: 600; color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 10px; }
    .sidebar-section { margin-bottom: 24px; }
    .filter-label { font-size: 0.8rem; font-weight: 500; color: var(--ink-2); margin-bottom: 6px; display: block; }
    .filter-select { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; color: var(--ink); background: var(--paper); outline: none; cursor: pointer; }
    .filter-select:focus { border-color: var(--accent); }
    .search-input { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; color: var(--ink); background: var(--paper); outline: none; }
    .search-input:focus { border-color: var(--accent); }
    .search-input::placeholder { color: var(--ink-3); }
    .btn-reset { width: 100%; padding: 8px; font-size: 0.82rem; color: var(--ink-3); background: none; border: 1px solid var(--border); border-radius: 7px; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: color 0.2s, border-color 0.2s; margin-top: 8px; }
    .btn-reset:hover { color: var(--ink); border-color: #bbb; }
    .sidebar-stat { display: flex; justify-content: space-between; align-items: center; font-size: 0.83rem; color: var(--ink-2); padding: 6px 0; border-bottom: 1px solid var(--paper-2); }
    .sidebar-stat:last-child { border-bottom: none; }
    .sidebar-stat-val { font-weight: 600; color: var(--ink); }

    /* MAIN */
    .main-content { padding: 28px 32px; overflow-x: auto; }
    .main-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 22px; flex-wrap: wrap; gap: 12px; }
    .main-header h1 { font-size: 1.4rem; font-weight: 600; color: var(--ink); }
    .doc-count { font-size: 0.85rem; color: var(--ink-3); margin-left: 8px; font-weight: 400; }
    .btn-add { display: none; align-items: center; gap: 6px; padding: 9px 16px; background: linear-gradient(135deg,#7c3aed,#0891b2); color: #fff; font-family: 'DM Sans', sans-serif; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: opacity 0.2s, transform 0.15s; }
    .btn-add:hover { opacity: 0.9; transform: translateY(-1px); }

    /* TABLE */
    .table-wrap { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-sm); overflow: hidden; min-width: 800px; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--paper); }
    th { padding: 12px 14px; text-align: left; font-size: 0.74rem; font-weight: 600; color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.07em; border-bottom: 1px solid var(--border); white-space: nowrap; cursor: pointer; user-select: none; }
    th:hover { color: var(--ink-2); }
    th.sorted { color: var(--accent); }
    th .sort-arrow { margin-left: 4px; opacity: 0.5; }
    th.sorted .sort-arrow { opacity: 1; }
    td { padding: 13px 14px; font-size: 0.87rem; color: var(--ink-2); border-bottom: 1px solid var(--paper-2); vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fafaf8; }
    .td-docid { font-family: 'DM Mono', monospace; font-size: 0.82rem; font-weight: 500; color: var(--ink); white-space: nowrap; }
    .td-title { color: var(--ink); font-weight: 500; max-width: 260px; }
    .td-link a { display: inline-flex; align-items: center; gap: 4px; color: var(--accent); font-size: 0.82rem; text-decoration: none; white-space: nowrap; }
    .td-link a:hover { color: var(--accent-dk); text-decoration: underline; }
    .td-link .no-link { color: var(--ink-3); font-size: 0.8rem; }
    .td-schools { font-size: 0.8rem; color: var(--ink-3); }
    .td-schools .school-pill { display: inline-block; background: var(--paper-2); border-radius: 4px; padding: 1px 6px; margin: 1px; font-size: 0.75rem; color: var(--ink-2); }
    .td-actions { white-space: nowrap; }
    .btn-icon { background: none; border: 1px solid var(--border); border-radius: 6px; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; color: var(--ink-3); transition: color 0.2s, border-color 0.2s; }
    .btn-icon:hover { color: var(--ink); border-color: #bbb; }
    .btn-icon-delete:hover { color: #dc2626; border-color: #fca5a5; background: #fee2e2; }
    .admin-actions { display: none; align-items: center; gap: 6px; }

    /* BADGES */
    .badge { display: inline-flex; align-items: center; font-size: 0.7rem; font-weight: 600; padding: 2px 8px; border-radius: 20px; letter-spacing: 0.03em; white-space: nowrap; }
    .badge-teal   { background: #e0f2fe; color: #0e7490; }
    .badge-amber  { background: #fef3c7; color: #92400e; }
    .badge-red    { background: #fee2e2; color: #991b1b; }
    .badge-neutral { background: var(--paper-2); color: var(--ink-2); }
    .badge-violet { background: #ede9fe; color: #6d28d9; }

    /* SKELETON / EMPTY */
    .skel { background: linear-gradient(90deg, var(--paper-2) 25%, var(--paper) 50%, var(--paper-2) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; display: block; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .empty-row td { text-align: center; padding: 60px; color: var(--ink-3); font-size: 0.9rem; }

    /* MODAL */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(28,28,46,0.55); backdrop-filter: blur(4px); z-index: 200; align-items: center; justify-content: center; padding: 24px; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--white); border-radius: 14px; width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); animation: modalIn 0.25s ease; }
    @keyframes modalIn { from { opacity: 0; transform: translateY(12px) scale(0.98); } to { opacity: 1; transform: none; } }
    .modal-head { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 16px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--white); z-index: 1; }
    .modal-head h3 { font-size: 1rem; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 1.4rem; color: var(--ink-3); cursor: pointer; line-height: 1; padding: 0; transition: color 0.2s; }
    .modal-close:hover { color: var(--ink); }
    .modal-body { padding: 20px 24px; display: flex; flex-direction: column; gap: 14px; }
    .modal-footer { display: flex; align-items: center; justify-content: flex-end; gap: 10px; padding: 16px 24px; border-top: 1px solid var(--border); position: sticky; bottom: 0; background: var(--white); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-label { font-size: 0.82rem; font-weight: 500; color: var(--ink-2); }
    .form-label .req { color: #dc2626; margin-left: 2px; }
    .form-input, .form-select, .form-textarea { padding: 9px 12px; border: 1px solid var(--border); border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; color: var(--ink); background: var(--paper); outline: none; transition: border-color 0.2s; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); background: var(--white); }
    .form-input::placeholder, .form-textarea::placeholder { color: var(--ink-3); }
    .form-textarea { resize: vertical; min-height: 80px; }
    .form-input.mono { font-family: 'DM Mono', monospace; font-size: 0.88rem; }
    .docid-preview { font-family: 'DM Mono', monospace; font-size: 1rem; font-weight: 600; color: var(--accent); padding: 10px 12px; background: #e0f2fe; border-radius: 7px; letter-spacing: 0.04em; text-align: center; }
    .docid-label { font-size: 0.74rem; color: var(--ink-3); text-align: center; margin-top: 4px; }
    .form-hint { font-size: 0.76rem; color: var(--ink-3); margin-top: 2px; }
    .btn-cancel { padding: 9px 18px; background: none; border: 1px solid var(--border); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.875rem; color: var(--ink-2); cursor: pointer; transition: border-color 0.2s; }
    .btn-cancel:hover { border-color: #bbb; }
    .btn-save { padding: 9px 20px; background: linear-gradient(135deg,#7c3aed,#0891b2); color: #fff; border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
    .btn-save:hover { opacity: 0.88; }
    .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-error { font-size: 0.82rem; color: #dc2626; background: #fee2e2; border-radius: 6px; padding: 8px 12px; display: none; }
    .modal-error.visible { display: block; }
    .section-divider { font-size: 0.72rem; font-weight: 600; color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.1em; padding-bottom: 6px; border-bottom: 1px solid var(--paper-2); margin-top: 4px; }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .page-layout { grid-template-columns: 1fr; }
      .sidebar { position: static; height: auto; border-right: none; border-bottom: 1px solid var(--border); padding: 16px; }
      .main-content { padding: 20px 16px; }
      .nav-links { display: none; }
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<nav class="top-nav" aria-label="Main navigation">
  <a href="index" class="nav-brand">
    <svg width="30" height="30" viewBox="0 0 32 32" fill="none" aria-hidden="true">
      <circle cx="16" cy="16" r="6" fill="#8b5cf6"/>
      <circle cx="16" cy="4.5" r="3.2" fill="#6d28d9" opacity="0.9"/>
      <circle cx="27.5" cy="22.5" r="3.2" fill="#6d28d9" opacity="0.9"/>
      <circle cx="4.5" cy="22.5" r="3.2" fill="#6d28d9" opacity="0.9"/>
      <line x1="16" y1="10" x2="16" y2="7.7" stroke="#c4b5fd" stroke-width="1.6" stroke-linecap="round"/>
      <line x1="21" y1="19.4" x2="24.7" y2="21.2" stroke="#c4b5fd" stroke-width="1.6" stroke-linecap="round"/>
      <line x1="11" y1="19.4" x2="7.3" y2="21.2" stroke="#c4b5fd" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
    <span class="nav-brand-name">CentralHub</span>
  </a>
  <div class="nav-links">
    <a href="index" class="nav-link">Dashboard</a>
    <a href="schools" class="nav-link">Schools</a>
    <a href="staff" class="nav-link">Staff</a>
    <a href="announcements" class="nav-link">Announcements</a>
    <a href="messageboard" class="nav-link">Message Board</a>
    <a href="documents" class="nav-link active">Documents</a>
  </div>
  <div class="nav-auth">
    <span class="nav-user-name"></span>
    <div class="nav-avatar" id="navAvatar" aria-hidden="true"></div>
    <button class="btn-logout" id="logoutBtn">Sign out</button>
  </div>
</nav>

<div class="page-layout">

  <!-- SIDEBAR -->
  <aside class="sidebar" aria-label="Filters">
    <div class="sidebar-section">
      <p class="sidebar-title">Search</p>
      <input class="search-input" id="searchInput" type="search" placeholder="Title or doc ID…" aria-label="Search documents">
    </div>
    <div class="sidebar-section">
      <p class="sidebar-title">Filter</p>
      <label class="filter-label" for="categoryFilter">Category</label>
      <select class="filter-select" id="categoryFilter" aria-label="Filter by category">
        <option value="">All categories</option>
        <option value="AP">AP — Academic Programs</option>
        <option value="AF">AF — Admin &amp; Finance</option>
        <option value="AS">AS — Academic Support</option>
        <option value="PD">PD — Professional Dev.</option>
        <option value="OP">OP — Operations</option>
        <option value="PL">PL — Policy &amp; Legal</option>
        <option value="QA">QA — Quality Assurance</option>
        <option value="IT">IT — Information Technology</option>
        <option value="BR">BR — Branding &amp; Comms</option>
      </select>
    </div>
    <div class="sidebar-section">
      <label class="filter-label" for="typeFilter">Document Type</label>
      <select class="filter-select" id="typeFilter" aria-label="Filter by type">
        <option value="">All types</option>
        <option value="PT">PT — Petunjuk Teknis</option>
        <option value="HG">HG — Handbook/Guide</option>
        <option value="FW">FW — Framework</option>
        <option value="PLN">PLN — Planning Document</option>
        <option value="POL">POL — Policy</option>
        <option value="SOP">SOP — Standard Operating Procedure</option>
        <option value="TL">TL — Template Letter</option>
        <option value="TMP">TMP — Template</option>
        <option value="RPT">RPT — Report</option>
      </select>
    </div>
    <div class="sidebar-section">
      <label class="filter-label" for="statusFilter">Status</label>
      <select class="filter-select" id="statusFilter" aria-label="Filter by status">
        <option value="">All statuses</option>
        <option value="active">Active</option>
        <option value="draft">Draft</option>
        <option value="archived">Archived</option>
      </select>
    </div>
    <button class="btn-reset" id="resetBtn">Reset filters</button>

    <div class="sidebar-section" style="margin-top: 24px;">
      <p class="sidebar-title">Stats</p>
      <div class="sidebar-stat">
        <span>Total</span>
        <span class="sidebar-stat-val" id="statTotal">—</span>
      </div>
      <div class="sidebar-stat">
        <span>Active</span>
        <span class="sidebar-stat-val" id="statActive">—</span>
      </div>
      <div class="sidebar-stat">
        <span>Draft</span>
        <span class="sidebar-stat-val" id="statDraft">—</span>
      </div>
      <div class="sidebar-stat">
        <span>Archived</span>
        <span class="sidebar-stat-val" id="statArchived">—</span>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main-content">
    <div class="main-header">
      <h1>Document Inventory <span class="doc-count" id="docCount"></span></h1>
      <button class="btn-add" id="addDocBtn" aria-label="Add new document">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" aria-hidden="true">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Add Document
      </button>
    </div>

    <div class="table-wrap">
      <table aria-label="Document inventory">
        <thead>
          <tr>
            <th data-col="docId">Document ID <span class="sort-arrow">↕</span></th>
            <th data-col="title">Title <span class="sort-arrow">↕</span></th>
            <th data-col="category">Category <span class="sort-arrow">↕</span></th>
            <th data-col="type">Type <span class="sort-arrow">↕</span></th>
            <th data-col="version">Version <span class="sort-arrow">↕</span></th>
            <th data-col="dateOfIssue">Date <span class="sort-arrow">↕</span></th>
            <th>G-Drive</th>
            <th>Schools</th>
            <th data-col="status">Status <span class="sort-arrow">↕</span></th>
            <th class="admin-actions" style="min-width:80px;">Actions</th>
          </tr>
        </thead>
        <tbody id="docTableBody">
          <!-- skeleton rows -->
          <tr><td><span class="skel" style="width:130px;height:14px;"></span></td><td><span class="skel" style="width:200px;height:14px;"></span></td><td><span class="skel" style="width:40px;height:14px;"></span></td><td><span class="skel" style="width:40px;height:14px;"></span></td><td><span class="skel" style="width:36px;height:14px;"></span></td><td><span class="skel" style="width:80px;height:14px;"></span></td><td><span class="skel" style="width:40px;height:14px;"></span></td><td><span class="skel" style="width:60px;height:14px;"></span></td><td><span class="skel" style="width:50px;height:14px;"></span></td></tr>
          <tr><td><span class="skel" style="width:130px;height:14px;"></span></td><td><span class="skel" style="width:180px;height:14px;"></span></td><td><span class="skel" style="width:40px;height:14px;"></span></td><td><span class="skel" style="width:40px;height:14px;"></span></td><td><span class="skel" style="width:36px;height:14px;"></span></td><td><span class="skel" style="width:80px;height:14px;"></span></td><td><span class="skel" style="width:40px;height:14px;"></span></td><td><span class="skel" style="width:60px;height:14px;"></span></td><td><span class="skel" style="width:50px;height:14px;"></span></td></tr>
          <tr><td><span class="skel" style="width:130px;height:14px;"></span></td><td><span class="skel" style="width:220px;height:14px;"></span></td><td><span class="skel" style="width:40px;height:14px;"></span></td><td><span class="skel" style="width:40px;height:14px;"></span></td><td><span class="skel" style="width:36px;height:14px;"></span></td><td><span class="skel" style="width:80px;height:14px;"></span></td><td><span class="skel" style="width:40px;height:14px;"></span></td><td><span class="skel" style="width:60px;height:14px;"></span></td><td><span class="skel" style="width:50px;height:14px;"></span></td></tr>
        </tbody>
      </table>
    </div>
  </main>
</div>

<!-- ADD / EDIT MODAL -->
<div class="modal-overlay" id="docModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modalTitle">Add Document</h3>
      <button class="modal-close" id="modalClose" aria-label="Close">&#x2715;</button>
    </div>
    <div class="modal-body">
      <!-- Auto-generated Document ID Preview -->
      <div>
        <div class="docid-preview" id="docIdPreview">EDU–—–—–—</div>
        <div class="docid-label">Document ID (auto-generated)</div>
      </div>

      <p class="section-divider">Document Details</p>

      <div class="form-group">
        <label class="form-label" for="fTitle">Title <span class="req">*</span></label>
        <input class="form-input" id="fTitle" type="text" placeholder="e.g. Kurikulum Merdeka Implementation Guide">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="fCategory">Category <span class="req">*</span></label>
          <select class="form-select" id="fCategory">
            <option value="">— select —</option>
            <option value="AP">AP — Academic Programs</option>
            <option value="AF">AF — Admin &amp; Finance</option>
            <option value="AS">AS — Academic Support</option>
            <option value="PD">PD — Professional Dev.</option>
            <option value="OP">OP — Operations</option>
            <option value="PL">PL — Policy &amp; Legal</option>
            <option value="QA">QA — Quality Assurance</option>
            <option value="IT">IT — Information Technology</option>
            <option value="BR">BR — Branding &amp; Comms</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="fType">Document Type <span class="req">*</span></label>
          <select class="form-select" id="fType">
            <option value="">— select —</option>
            <option value="PT">PT — Petunjuk Teknis</option>
            <option value="HG">HG — Handbook/Guide</option>
            <option value="FW">FW — Framework</option>
            <option value="PLN">PLN — Planning Document</option>
            <option value="POL">POL — Policy</option>
            <option value="SOP">SOP — SOP</option>
            <option value="TL">TL — Template Letter</option>
            <option value="TMP">TMP — Template</option>
            <option value="RPT">RPT — Report</option>
          </select>
        </div>
      </div>

      <div class="form-row-3">
        <div class="form-group">
          <label class="form-label" for="fVersion">Version <span class="req">*</span></label>
          <input class="form-input mono" id="fVersion" type="text" placeholder="1.0" value="1.0">
        </div>
        <div class="form-group">
          <label class="form-label" for="fDate">Date of Issue <span class="req">*</span></label>
          <input class="form-input" id="fDate" type="date">
        </div>
        <div class="form-group">
          <label class="form-label" for="fStatus">Status <span class="req">*</span></label>
          <select class="form-select" id="fStatus">
            <option value="active">Active</option>
            <option value="draft">Draft</option>
            <option value="archived">Archived</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="fPreparedBy">Prepared By <span class="req">*</span></label>
        <input class="form-input" id="fPreparedBy" type="text" placeholder="Name or department">
      </div>

      <p class="section-divider">Distribution</p>

      <div class="form-group">
        <label class="form-label" for="fDriveLink">G-Drive Link</label>
        <input class="form-input" id="fDriveLink" type="url" placeholder="https://drive.google.com/…">
        <span class="form-hint">Paste the Google Drive sharing link for direct access.</span>
      </div>

      <div class="form-group">
        <label class="form-label" for="fSchools">Schools Distributed To</label>
        <input class="form-input" id="fSchools" type="text" placeholder="e.g. SMPN 1 Bandung, SDN Harapan Jaya">
        <span class="form-hint">Separate multiple schools with commas.</span>
      </div>

      <div class="form-group">
        <label class="form-label" for="fDescription">Notes / Description</label>
        <textarea class="form-textarea" id="fDescription" placeholder="Optional notes about this document…"></textarea>
      </div>

      <div class="modal-error" id="modalError"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" id="modalCancel">Cancel</button>
      <button class="btn-save" id="modalSave">Save Document</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="auth-guard.js"></script>
<script>
  // ── XSS helper ──────────────────────────────────────────
  function esc(str) {
    return String(str ?? '')
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  // ── State ────────────────────────────────────────────────
  let allDocs    = [];   // raw Firestore data
  let isAdmin    = false;
  let editId     = null; // Firestore doc ID when editing
  let editSerial = null; // preserve serial on edit
  let editDocId  = null; // preserve docId string on edit

  let sortCol = 'dateOfIssue';
  let sortDir = -1; // -1 = desc, 1 = asc

  // ── DOM refs ─────────────────────────────────────────────
  const tbody        = document.getElementById('docTableBody');
  const docCount     = document.getElementById('docCount');
  const searchInput  = document.getElementById('searchInput');
  const catFilter    = document.getElementById('categoryFilter');
  const typeFilter   = document.getElementById('typeFilter');
  const statusFilter = document.getElementById('statusFilter');
  const resetBtn     = document.getElementById('resetBtn');
  const addDocBtn    = document.getElementById('addDocBtn');
  const modalEl      = document.getElementById('docModal');
  const modalTitle   = document.getElementById('modalTitle');
  const modalClose   = document.getElementById('modalClose');
  const modalCancel  = document.getElementById('modalCancel');
  const modalSave    = document.getElementById('modalSave');
  const modalError   = document.getElementById('modalError');
  const docIdPreview = document.getElementById('docIdPreview');
  const fCategory    = document.getElementById('fCategory');
  const fType        = document.getElementById('fType');
  const fTitle       = document.getElementById('fTitle');
  const fVersion     = document.getElementById('fVersion');
  const fDate        = document.getElementById('fDate');
  const fStatus      = document.getElementById('fStatus');
  const fPreparedBy  = document.getElementById('fPreparedBy');
  const fDriveLink   = document.getElementById('fDriveLink');
  const fSchools     = document.getElementById('fSchools');
  const fDescription = document.getElementById('fDescription');

  // ── Auth ready ───────────────────────────────────────────
  document.addEventListener('authReady', ({ detail }) => {
    isAdmin = detail.profile?.role === 'admin';
    if (isAdmin) {
      addDocBtn.style.display = 'flex';
      document.querySelectorAll('.admin-actions').forEach(el => el.style.display = 'flex');
    }
    loadDocuments();
  });

  // ── Load & render ────────────────────────────────────────
  async function loadDocuments() {
    try {
      const snap = await window.db.collection('documents')
        .orderBy('createdAt', 'desc')
        .get();
      allDocs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      updateStats();
      renderTable();
    } catch (err) {
      console.error('Failed to load documents:', err);
      tbody.innerHTML = '<tr class="empty-row"><td colspan="10">Failed to load documents. Check console.</td></tr>';
    }
  }

  function updateStats() {
    document.getElementById('statTotal').textContent    = allDocs.length;
    document.getElementById('statActive').textContent   = allDocs.filter(d => d.status === 'active').length;
    document.getElementById('statDraft').textContent    = allDocs.filter(d => d.status === 'draft').length;
    document.getElementById('statArchived').textContent = allDocs.filter(d => d.status === 'archived').length;
  }

  function applyFilters() {
    const q   = searchInput.value.trim().toLowerCase();
    const cat = catFilter.value;
    const typ = typeFilter.value;
    const st  = statusFilter.value;
    return allDocs.filter(doc => {
      if (cat && doc.category !== cat) return false;
      if (typ && doc.type      !== typ) return false;
      if (st  && doc.status    !== st)  return false;
      if (q) {
        const haystack = (doc.docId + ' ' + doc.title + ' ' + doc.preparedBy).toLowerCase();
        if (!haystack.includes(q)) return false;
      }
      return true;
    });
  }

  function applySort(docs) {
    return [...docs].sort((a, b) => {
      let av = a[sortCol] ?? '';
      let bv = b[sortCol] ?? '';
      if (typeof av === 'string') av = av.toLowerCase();
      if (typeof bv === 'string') bv = bv.toLowerCase();
      if (av < bv) return -sortDir;
      if (av > bv) return  sortDir;
      return 0;
    });
  }

  function renderTable() {
    const filtered = applyFilters();
    const sorted   = applySort(filtered);
    docCount.textContent = filtered.length === allDocs.length
      ? `(${allDocs.length})`
      : `(${filtered.length} of ${allDocs.length})`;

    if (sorted.length === 0) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="10">No documents found.</td></tr>';
      return;
    }

    tbody.innerHTML = sorted.map(doc => {
      const statusBadge = {
        active:   '<span class="badge badge-teal">Active</span>',
        draft:    '<span class="badge badge-amber">Draft</span>',
        archived: '<span class="badge badge-neutral">Archived</span>',
      }[doc.status] || '<span class="badge badge-neutral">—</span>';

      const driveCell = doc.driveLink
        ? `<a href="${esc(doc.driveLink)}" target="_blank" rel="noopener noreferrer">
             <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
             Open
           </a>`
        : '<span class="no-link">—</span>';

      const schools = Array.isArray(doc.schools) ? doc.schools : [];
      const schoolsCell = schools.length > 0
        ? schools.map(s => `<span class="school-pill">${esc(s.trim())}</span>`).join('')
        : '<span style="color:var(--ink-3);font-size:0.8rem;">—</span>';

      const adminCells = isAdmin ? `
        <td class="td-actions admin-actions" style="display:flex;">
          <button class="btn-icon" onclick="openEditModal('${esc(doc.id)}')" title="Edit" aria-label="Edit document">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" aria-hidden="true"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>
          </button>
          <button class="btn-icon btn-icon-delete" onclick="deleteDoc('${esc(doc.id)}')" title="Delete" aria-label="Delete document">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" aria-hidden="true"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
          </button>
        </td>` : '<td class="td-actions"></td>';

      return `<tr>
        <td class="td-docid">${esc(doc.docId)}</td>
        <td class="td-title">${esc(doc.title)}</td>
        <td><span class="badge badge-violet">${esc(doc.category)}</span></td>
        <td><span class="badge badge-neutral">${esc(doc.type)}</span></td>
        <td><span style="font-family:'DM Mono',monospace;font-size:0.8rem;">v${esc(doc.version)}</span></td>
        <td>${esc(doc.dateOfIssue || '—')}</td>
        <td class="td-link">${driveCell}</td>
        <td class="td-schools">${schoolsCell}</td>
        <td>${statusBadge}</td>
        ${adminCells}
      </tr>`;
    }).join('');
  }

  // ── Sorting ──────────────────────────────────────────────
  document.querySelectorAll('th[data-col]').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.col;
      if (sortCol === col) { sortDir *= -1; } else { sortCol = col; sortDir = -1; }
      document.querySelectorAll('th').forEach(t => t.classList.remove('sorted'));
      th.classList.add('sorted');
      th.querySelector('.sort-arrow').textContent = sortDir === 1 ? '↑' : '↓';
      renderTable();
    });
  });

  // ── Filters ──────────────────────────────────────────────
  [searchInput, catFilter, typeFilter, statusFilter].forEach(el => {
    el.addEventListener('input', renderTable);
    el.addEventListener('change', renderTable);
  });
  resetBtn.addEventListener('click', () => {
    searchInput.value = catFilter.value = typeFilter.value = statusFilter.value = '';
    renderTable();
  });

  // ── Modal open/close ─────────────────────────────────────
  function openModal() { modalEl.classList.add('open'); }
  function closeModal() {
    modalEl.classList.remove('open');
    resetForm();
  }
  [modalClose, modalCancel].forEach(el => el.addEventListener('click', closeModal));
  modalEl.addEventListener('click', e => { if (e.target === modalEl) closeModal(); });

  function resetForm() {
    editId = null; editSerial = null; editDocId = null;
    modalTitle.textContent = 'Add Document';
    [fTitle, fVersion, fDate, fPreparedBy, fDriveLink, fSchools, fDescription].forEach(f => f.value = '');
    fVersion.value = '1.0';
    fCategory.value = fType.value = fStatus.value = '';
    fStatus.value = 'active';
    docIdPreview.textContent = 'EDU\u2013\u2014\u2013\u2014\u2013\u2014';
    modalError.textContent = '';
    modalError.classList.remove('visible');
    modalSave.disabled = false;
  }

  addDocBtn.addEventListener('click', () => {
    resetForm();
    // default date to today
    fDate.value = new Date().toISOString().slice(0, 10);
    openModal();
  });

  // ── Auto-generate doc ID preview ─────────────────────────
  async function refreshDocIdPreview() {
    const cat = fCategory.value;
    const typ = fType.value;
    if (!cat || !typ) {
      docIdPreview.textContent = 'EDU\u2013\u2014\u2013\u2014\u2013\u2014';
      return;
    }
    // On edit, preserve the original serial (don't re-calculate)
    if (editId && editSerial !== null) {
      const serial = String(editSerial).padStart(3, '0');
      docIdPreview.textContent = `EDU\u2013${cat}\u2013${typ}\u2013${serial}`;
      return;
    }
    try {
      const snap = await window.db.collection('documents')
        .where('category', '==', cat)
        .where('type', '==', typ)
        .get();
      let maxSerial = 0;
      snap.forEach(doc => {
        const s = parseInt(doc.data().serial, 10) || 0;
        if (s > maxSerial) maxSerial = s;
      });
      const nextSerial = maxSerial + 1;
      const serial = String(nextSerial).padStart(3, '0');
      docIdPreview.textContent = `EDU\u2013${cat}\u2013${typ}\u2013${serial}`;
    } catch (err) {
      console.warn('Could not compute serial:', err);
      docIdPreview.textContent = `EDU\u2013${cat}\u2013${typ}\u2013???`;
    }
  }

  fCategory.addEventListener('change', refreshDocIdPreview);
  fType.addEventListener('change', refreshDocIdPreview);

  // ── Open edit modal ──────────────────────────────────────
  function openEditModal(firestoreId) {
    const doc = allDocs.find(d => d.id === firestoreId);
    if (!doc) return;
    editId     = firestoreId;
    editSerial = doc.serial;
    editDocId  = doc.docId;

    modalTitle.textContent = 'Edit Document';
    fTitle.value       = doc.title       || '';
    fCategory.value    = doc.category    || '';
    fType.value        = doc.type        || '';
    fVersion.value     = doc.version     || '1.0';
    fDate.value        = doc.dateOfIssue || '';
    fStatus.value      = doc.status      || 'active';
    fPreparedBy.value  = doc.preparedBy  || '';
    fDriveLink.value   = doc.driveLink   || '';
    fSchools.value     = Array.isArray(doc.schools) ? doc.schools.join(', ') : '';
    fDescription.value = doc.description || '';
    docIdPreview.textContent = editDocId;
    openModal();
  }

  // ── Save ─────────────────────────────────────────────────
  modalSave.addEventListener('click', async () => {
    const title      = fTitle.value.trim();
    const category   = fCategory.value;
    const type       = fType.value;
    const version    = fVersion.value.trim();
    const dateOfIssue = fDate.value;
    const status     = fStatus.value;
    const preparedBy = fPreparedBy.value.trim();
    const driveLink  = fDriveLink.value.trim();
    const schools    = fSchools.value.split(',').map(s => s.trim()).filter(Boolean);
    const description = fDescription.value.trim();

    // Validation
    if (!title)       return showError('Title is required.');
    if (!category)    return showError('Category is required.');
    if (!type)        return showError('Document type is required.');
    if (!version)     return showError('Version is required.');
    if (!dateOfIssue) return showError('Date of Issue is required.');
    if (!preparedBy)  return showError('Prepared By is required.');

    modalSave.disabled = true;
    modalError.classList.remove('visible');

    try {
      let docId, serial;

      if (editId) {
        // Preserve existing docId and serial; allow category/type changes update preview only
        docId  = editDocId;
        serial = editSerial;
        // If category or type changed, we re-compute a new serial
        const original = allDocs.find(d => d.id === editId);
        if (original && (original.category !== category || original.type !== type)) {
          const snap = await window.db.collection('documents')
            .where('category', '==', category)
            .where('type', '==', type)
            .get();
          let maxSerial = 0;
          snap.forEach(d => {
            if (d.id === editId) return; // skip self
            const s = parseInt(d.data().serial, 10) || 0;
            if (s > maxSerial) maxSerial = s;
          });
          serial = maxSerial + 1;
          docId  = `EDU\u2013${category}\u2013${type}\u2013${String(serial).padStart(3, '0')}`;
        }
        await window.db.collection('documents').doc(editId).update({
          docId, title, category, type, version, dateOfIssue, status,
          preparedBy, driveLink, schools, description, serial,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
      } else {
        // New doc: compute serial
        const snap = await window.db.collection('documents')
          .where('category', '==', category)
          .where('type', '==', type)
          .get();
        let maxSerial = 0;
        snap.forEach(d => {
          const s = parseInt(d.data().serial, 10) || 0;
          if (s > maxSerial) maxSerial = s;
        });
        serial = maxSerial + 1;
        docId  = `EDU\u2013${category}\u2013${type}\u2013${String(serial).padStart(3, '0')}`;
        await window.db.collection('documents').add({
          docId, title, category, type, version, dateOfIssue, status,
          preparedBy, driveLink, schools, description, serial,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
      }

      closeModal();
      await loadDocuments();
    } catch (err) {
      console.error('Save failed:', err);
      showError('Failed to save. Please try again.');
      modalSave.disabled = false;
    }
  });

  function showError(msg) {
    modalError.textContent = msg;
    modalError.classList.add('visible');
  }

  // ── Delete ───────────────────────────────────────────────
  async function deleteDoc(firestoreId) {
    const doc = allDocs.find(d => d.id === firestoreId);
    if (!doc) return;
    if (!confirm(`Delete "${doc.docId} — ${doc.title}"?\n\nThis action cannot be undone.`)) return;
    try {
      await window.db.collection('documents').doc(firestoreId).delete();
      await loadDocuments();
    } catch (err) {
      console.error('Delete failed:', err);
      alert('Failed to delete document. See console for details.');
    }
  }
</script>
</body>
</html>
