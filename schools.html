<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schools — CentralHub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Lora:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #1c1c2e; --ink-2: #44445a; --ink-3: #8888a8;
      --paper: #f7f6f3; --paper-2: #efede8; --white: #ffffff;
      --border: #e0ddd6; --accent: #0891b2; --accent-dk: #0e7490;
      --shadow-sm: 0 1px 4px rgba(28,28,46,.07);
      --shadow: 0 3px 14px rgba(28,28,46,.10);
      --shadow-lg: 0 10px 40px rgba(28,28,46,.16);
      --radius: 10px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--paper); color: var(--ink); min-height: 100vh; }

    /* NAV */
    .top-nav { position: sticky; top: 0; z-index: 100; height: 62px; padding: 0 28px; display: flex; align-items: center; gap: 28px; background: rgba(5,5,16,0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.08); }
    .nav-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; flex-shrink: 0; }
    .nav-brand-name { font-size: 1.05rem; font-weight: 600; color: #fff; letter-spacing: -0.02em; }
    .nav-links { display: flex; align-items: center; gap: 2px; flex: 1; }
    .nav-link { font-size: 0.875rem; font-weight: 500; color: rgba(255,255,255,0.6); text-decoration: none; padding: 6px 12px; border-radius: 6px; transition: color 0.2s, background 0.2s; }
    .nav-link:hover { color: #fff; background: rgba(255,255,255,0.07); }
    .nav-link.active { color: #fff; background: rgba(255,255,255,0.10); }
    .nav-auth { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    .nav-user-name { font-size: 0.875rem; color: rgba(255,255,255,0.65); }
    .nav-avatar { width: 34px; height: 34px; border-radius: 50%; background: linear-gradient(135deg,#7c3aed,#0891b2); display: flex; align-items: center; justify-content: center; font-size: 0.78rem; font-weight: 700; color: #fff; flex-shrink: 0; user-select: none; }
    .btn-logout { font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 500; color: rgba(255,255,255,0.48); background: none; border: 1px solid rgba(255,255,255,0.12); border-radius: 6px; padding: 5px 12px; cursor: pointer; transition: color 0.2s, border-color 0.2s; }
    .btn-logout:hover { color: #fff; border-color: rgba(255,255,255,0.28); }

    /* PAGE LAYOUT */
    .page-layout { display: grid; grid-template-columns: 220px 1fr; min-height: calc(100vh - 62px); }

    /* SIDEBAR */
    .sidebar { background: var(--white); border-right: 1px solid var(--border); padding: 24px 16px; position: sticky; top: 62px; height: calc(100vh - 62px); overflow-y: auto; }
    .sidebar-title { font-size: 0.7rem; font-weight: 600; color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 10px; }
    .sidebar-section { margin-bottom: 24px; }
    .filter-label { font-size: 0.8rem; font-weight: 500; color: var(--ink-2); margin-bottom: 6px; display: block; }
    .filter-select { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; color: var(--ink); background: var(--paper); outline: none; cursor: pointer; }
    .filter-select:focus { border-color: var(--accent); }
    .search-input { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; color: var(--ink); background: var(--paper); outline: none; }
    .search-input:focus { border-color: var(--accent); }
    .search-input::placeholder { color: var(--ink-3); }
    .btn-reset { width: 100%; padding: 8px; font-size: 0.82rem; color: var(--ink-3); background: none; border: 1px solid var(--border); border-radius: 7px; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: color 0.2s, border-color 0.2s; margin-top: 8px; }
    .btn-reset:hover { color: var(--ink); border-color: #bbb; }

    /* MAIN */
    .main-content { padding: 28px 32px; }
    .main-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 22px; }
    .main-header h1 { font-size: 1.4rem; font-weight: 600; color: var(--ink); }
    .school-count { font-size: 0.85rem; color: var(--ink-3); margin-left: 8px; font-weight: 400; }
    .btn-add { display: none; align-items: center; gap: 6px; padding: 9px 16px; background: linear-gradient(135deg,#7c3aed,#0891b2); color: #fff; font-family: 'DM Sans', sans-serif; font-size: 0.875rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: opacity 0.2s, transform 0.15s; }
    .btn-add:hover { opacity: 0.9; transform: translateY(-1px); }

    /* CARD GRID */
    .school-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .school-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow-sm); transition: box-shadow 0.2s, transform 0.2s; display: flex; flex-direction: column; gap: 6px; }
    .school-card:hover { box-shadow: var(--shadow); transform: translateY(-2px); }
    .card-top { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
    .school-name { font-size: 1rem; font-weight: 600; color: var(--ink); line-height: 1.3; }
    .school-city { font-size: 0.83rem; color: var(--ink-2); }
    .school-email { font-size: 0.78rem; color: var(--ink-3); font-family: 'DM Mono', monospace; margin-top: 2px; }
    .card-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--paper-2); }
    .btn-view { font-size: 0.82rem; font-weight: 500; color: var(--accent); background: none; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; padding: 0; transition: color 0.2s; }
    .btn-view:hover { color: var(--accent-dk); }
    .btn-edit-card { font-size: 0.82rem; font-weight: 500; color: var(--ink-3); background: none; border: 1px solid var(--border); border-radius: 6px; padding: 4px 10px; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: color 0.2s, border-color 0.2s; }
    .btn-edit-card:hover { color: var(--ink); border-color: #bbb; }

    /* BADGES */
    .badge { display: inline-flex; align-items: center; font-size: 0.7rem; font-weight: 600; padding: 2px 8px; border-radius: 20px; letter-spacing: 0.03em; }
    .badge-teal   { background: #e0f2fe; color: #0e7490; }
    .badge-amber  { background: #fef3c7; color: #92400e; }
    .badge-red    { background: #fee2e2; color: #991b1b; }
    .badge-type   { background: var(--paper-2); color: var(--ink-2); }

    /* EMPTY / SKELETON */
    .empty-state { grid-column: 1/-1; padding: 60px; text-align: center; color: var(--ink-3); font-size: 0.9rem; }
    .skel { background: linear-gradient(90deg, var(--paper-2) 25%, var(--paper) 50%, var(--paper-2) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; display: block; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* MODAL */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(28,28,46,0.55); backdrop-filter: blur(4px); z-index: 200; align-items: center; justify-content: center; padding: 24px; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--white); border-radius: 14px; width: 100%; max-width: 480px; box-shadow: var(--shadow-lg); animation: modalIn 0.25s ease; }
    @keyframes modalIn { from { opacity: 0; transform: translateY(12px) scale(0.98); } to { opacity: 1; transform: none; } }
    .modal-head { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 16px; border-bottom: 1px solid var(--border); }
    .modal-head h3 { font-size: 1rem; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 1.4rem; color: var(--ink-3); cursor: pointer; line-height: 1; padding: 0; transition: color 0.2s; }
    .modal-close:hover { color: var(--ink); }
    .modal-body { padding: 20px 24px; display: flex; flex-direction: column; gap: 14px; }
    .modal-footer { display: flex; align-items: center; justify-content: flex-end; gap: 10px; padding: 16px 24px; border-top: 1px solid var(--border); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-label { font-size: 0.82rem; font-weight: 500; color: var(--ink-2); }
    .form-input, .form-select { padding: 9px 12px; border: 1px solid var(--border); border-radius: 7px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; color: var(--ink); background: var(--paper); outline: none; transition: border-color 0.2s; }
    .form-input:focus, .form-select:focus { border-color: var(--accent); background: var(--white); }
    .form-input::placeholder { color: var(--ink-3); }
    .btn-cancel { padding: 9px 18px; background: none; border: 1px solid var(--border); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.875rem; color: var(--ink-2); cursor: pointer; transition: border-color 0.2s; }
    .btn-cancel:hover { border-color: #bbb; }
    .btn-save { padding: 9px 20px; background: linear-gradient(135deg,#7c3aed,#0891b2); color: #fff; border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
    .btn-save:hover { opacity: 0.88; }
    .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-error { font-size: 0.82rem; color: #dc2626; background: #fee2e2; border-radius: 6px; padding: 8px 12px; display: none; }
    .modal-error.visible { display: block; }

    /* DETAIL MODAL */
    .detail-field { display: flex; flex-direction: column; gap: 3px; padding: 10px 0; border-bottom: 1px solid var(--paper-2); }
    .detail-field:last-child { border-bottom: none; }
    .detail-key { font-size: 0.76rem; font-weight: 500; color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.06em; }
    .detail-val { font-size: 0.9rem; color: var(--ink); }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .page-layout { grid-template-columns: 1fr; }
      .sidebar { position: static; height: auto; border-right: none; border-bottom: 1px solid var(--border); padding: 16px; }
      .main-content { padding: 20px 16px; }
      .nav-links { display: none; }
    }
  </style>
</head>
<body>

<nav class="top-nav" aria-label="Main navigation">
  <a href="index" class="nav-brand">
    <svg width="30" height="30" viewBox="0 0 32 32" fill="none" aria-hidden="true">
      <circle cx="16" cy="16" r="6" fill="#8b5cf6"/>
      <circle cx="16" cy="4.5" r="3.2" fill="#6d28d9" opacity="0.9"/>
      <circle cx="27.5" cy="22.5" r="3.2" fill="#6d28d9" opacity="0.9"/>
      <circle cx="4.5" cy="22.5" r="3.2" fill="#6d28d9" opacity="0.9"/>
      <line x1="16" y1="10" x2="16" y2="7.7" stroke="#c4b5fd" stroke-width="1.6" stroke-linecap="round"/>
      <line x1="21" y1="19.4" x2="24.7" y2="21.2" stroke="#c4b5fd" stroke-width="1.6" stroke-linecap="round"/>
      <line x1="11" y1="19.4" x2="7.3" y2="21.2" stroke="#c4b5fd" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
    <span class="nav-brand-name">CentralHub</span>
  </a>
  <div class="nav-links">
    <a href="index" class="nav-link">Dashboard</a>
    <a href="schools" class="nav-link active">Schools</a>
    <a href="staff" class="nav-link">Staff</a>
    <a href="announcements" class="nav-link">Announcements</a>
    <a href="messageboard" class="nav-link">Message Board</a>
    <a href="documents" class="nav-link">Documents</a>
  </div>
  <div class="nav-auth">
    <span class="nav-user-name"></span>
    <div class="nav-avatar" id="navAvatar" aria-hidden="true"></div>
    <button class="btn-logout" id="logoutBtn">Sign out</button>
  </div>
</nav>

<div class="page-layout">

  <!-- SIDEBAR -->
  <aside class="sidebar" aria-label="Filters">
    <div class="sidebar-section">
      <p class="sidebar-title">Search</p>
      <input class="search-input" id="searchInput" type="search" placeholder="Name or city…" aria-label="Search schools">
    </div>
    <div class="sidebar-section">
      <p class="sidebar-title">Filter</p>
      <label class="filter-label" for="typeFilter">School Type</label>
      <select class="filter-select" id="typeFilter" aria-label="Filter by type">
        <option value="">All types</option>
        <option value="SD">SD</option>
        <option value="SMP">SMP</option>
        <option value="SMA">SMA</option>
        <option value="SMK">SMK</option>
      </select>
    </div>
    <div class="sidebar-section">
      <label class="filter-label" for="statusFilter">Status</label>
      <select class="filter-select" id="statusFilter" aria-label="Filter by status">
        <option value="">All statuses</option>
        <option value="active">Active</option>
        <option value="pending">Pending</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>
    <button class="btn-reset" id="resetBtn">Reset filters</button>
  </aside>

  <!-- MAIN -->
  <main class="main-content">
    <div class="main-header">
      <h1>Schools <span class="school-count" id="schoolCount"></span></h1>
      <button class="btn-add" id="addSchoolBtn" aria-label="Add new school">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" aria-hidden="true">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Add School
      </button>
    </div>
    <div class="school-grid" id="schoolGrid">
      <!-- skeleton placeholders -->
      <div class="school-card"><span class="skel" style="height:14px;width:60%;margin-bottom:8px"></span><span class="skel" style="height:20px;width:80%"></span><span class="skel" style="height:13px;width:50%;margin-top:6px"></span></div>
      <div class="school-card"><span class="skel" style="height:14px;width:60%;margin-bottom:8px"></span><span class="skel" style="height:20px;width:80%"></span><span class="skel" style="height:13px;width:50%;margin-top:6px"></span></div>
      <div class="school-card"><span class="skel" style="height:14px;width:60%;margin-bottom:8px"></span><span class="skel" style="height:20px;width:80%"></span><span class="skel" style="height:13px;width:50%;margin-top:6px"></span></div>
    </div>
  </main>
</div>

<!-- ADD / EDIT MODAL -->
<div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modalTitle">Add School</h3>
      <button class="modal-close" id="modalClose" aria-label="Close dialog">&#215;</button>
    </div>
    <div class="modal-body">
      <div class="modal-error" id="modalError" role="alert"></div>
      <div class="form-group">
        <label class="form-label" for="fieldName">School Name *</label>
        <input class="form-input" id="fieldName" placeholder="e.g. SMPN 1 Jakarta" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="fieldType">Type *</label>
          <select class="form-select" id="fieldType">
            <option value="">Select…</option>
            <option value="SD">SD</option>
            <option value="SMP">SMP</option>
            <option value="SMA">SMA</option>
            <option value="SMK">SMK</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="fieldStatus">Status</label>
          <select class="form-select" id="fieldStatus">
            <option value="active">Active</option>
            <option value="pending">Pending</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" for="fieldCity">City *</label>
        <input class="form-input" id="fieldCity" placeholder="e.g. Jakarta">
      </div>
      <div class="form-group">
        <label class="form-label" for="fieldAdminEmail">Admin Email</label>
        <input class="form-input" type="email" id="fieldAdminEmail" placeholder="admin@eduversal.org">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" id="cancelBtn" type="button">Cancel</button>
      <button class="btn-save" id="saveBtn" type="button">Save School</button>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="detailOverlay" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
  <div class="modal">
    <div class="modal-head">
      <h3 id="detailTitle">School Details</h3>
      <button class="modal-close" id="detailClose" aria-label="Close dialog">&#215;</button>
    </div>
    <div class="modal-body" id="detailBody"></div>
    <div class="modal-footer">
      <button class="btn-cancel" id="detailCloseBtn">Close</button>
      <button class="btn-save" id="detailEditBtn" style="display:none">Edit School</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="auth-guard.js"></script>
<script>
  let allSchools  = [];
  let isAdmin     = false;
  let editingId   = null;
  let viewingId   = null;

  // ===== Auth ready =====
  document.addEventListener('authReady', async ({ detail: { profile } }) => {
    isAdmin = profile.role === 'admin';
    if (isAdmin) document.getElementById('addSchoolBtn').style.display = 'flex';
    await loadSchools();
    bindFilters();
    bindModal();
  });

  // ===== Load =====
  async function loadSchools() {
    try {
      const snap = await db.collection('schools').orderBy('name').get();
      allSchools = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      applyFilters();
    } catch (e) {
      document.getElementById('schoolGrid').innerHTML =
        '<div class="empty-state">Could not load schools. Check Firestore rules.</div>';
    }
  }

  // ===== Filters =====
  function bindFilters() {
    ['searchInput','typeFilter','statusFilter'].forEach(id =>
      document.getElementById(id).addEventListener('input', applyFilters));
    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('searchInput').value = '';
      document.getElementById('typeFilter').value  = '';
      document.getElementById('statusFilter').value = '';
      applyFilters();
    });
  }

  function applyFilters() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    const t = document.getElementById('typeFilter').value;
    const s = document.getElementById('statusFilter').value;
    const filtered = allSchools.filter(school =>
      (!q || school.name?.toLowerCase().includes(q) || school.city?.toLowerCase().includes(q)) &&
      (!t || school.type === t) &&
      (!s || school.status === s)
    );
    document.getElementById('schoolCount').textContent = `(${filtered.length})`;
    renderCards(filtered);
  }

  // ===== Render =====
  const STATUS_BADGE = {
    active:   '<span class="badge badge-teal">Active</span>',
    pending:  '<span class="badge badge-amber">Pending</span>',
    inactive: '<span class="badge badge-red">Inactive</span>',
  };

  function renderCards(list) {
    const grid = document.getElementById('schoolGrid');
    if (!list.length) {
      grid.innerHTML = '<div class="empty-state">No schools match your filters.</div>';
      return;
    }
    grid.innerHTML = list.map(s => `
      <div class="school-card">
        <div class="card-top">
          ${s.type ? `<span class="badge badge-type">${esc(s.type)}</span>` : ''}
          ${STATUS_BADGE[s.status] || '<span class="badge badge-amber">Unknown</span>'}
        </div>
        <p class="school-name">${esc(s.name || '—')}</p>
        <p class="school-city">${esc(s.city || '—')}</p>
        <p class="school-email">${esc(s.adminEmail || '')}</p>
        <div class="card-footer">
          <button class="btn-view" onclick="viewSchool('${s.id}')">View details →</button>
          ${isAdmin ? `<button class="btn-edit-card" onclick="editSchool('${s.id}')">Edit</button>` : ''}
        </div>
      </div>`).join('');
  }

  // ===== View detail =====
  function viewSchool(id) {
    const s = allSchools.find(x => x.id === id);
    if (!s) return;
    viewingId = id;
    document.getElementById('detailTitle').textContent = s.name || 'School Details';
    document.getElementById('detailBody').innerHTML = `
      <div class="detail-field"><p class="detail-key">Name</p><p class="detail-val">${esc(s.name||'—')}</p></div>
      <div class="detail-field"><p class="detail-key">Type</p><p class="detail-val">${esc(s.type||'—')}</p></div>
      <div class="detail-field"><p class="detail-key">City</p><p class="detail-val">${esc(s.city||'—')}</p></div>
      <div class="detail-field"><p class="detail-key">Status</p><p class="detail-val">${STATUS_BADGE[s.status]||s.status||'—'}</p></div>
      <div class="detail-field"><p class="detail-key">Admin Email</p><p class="detail-val">${esc(s.adminEmail||'—')}</p></div>`;
    if (isAdmin) document.getElementById('detailEditBtn').style.display = 'inline-flex';
    document.getElementById('detailOverlay').classList.add('open');
  }

  document.getElementById('detailClose').addEventListener('click', closeDetail);
  document.getElementById('detailCloseBtn').addEventListener('click', closeDetail);
  document.getElementById('detailEditBtn').addEventListener('click', () => { closeDetail(); editSchool(viewingId); });
  document.getElementById('detailOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeDetail(); });
  function closeDetail() { document.getElementById('detailOverlay').classList.remove('open'); }

  // ===== Add / Edit Modal =====
  function bindModal() {
    document.getElementById('addSchoolBtn').addEventListener('click', openAddModal);
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    document.getElementById('modalOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
    document.getElementById('saveBtn').addEventListener('click', saveSchool);
  }

  function openAddModal() {
    editingId = null;
    document.getElementById('modalTitle').textContent = 'Add School';
    ['fieldName','fieldCity','fieldAdminEmail'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('fieldType').value   = '';
    document.getElementById('fieldStatus').value = 'active';
    hideModalError();
    document.getElementById('modalOverlay').classList.add('open');
    document.getElementById('fieldName').focus();
  }

  function editSchool(id) {
    const s = allSchools.find(x => x.id === id);
    if (!s) return;
    editingId = id;
    document.getElementById('modalTitle').textContent   = 'Edit School';
    document.getElementById('fieldName').value          = s.name        || '';
    document.getElementById('fieldType').value          = s.type        || '';
    document.getElementById('fieldStatus').value        = s.status      || 'active';
    document.getElementById('fieldCity').value          = s.city        || '';
    document.getElementById('fieldAdminEmail').value    = s.adminEmail  || '';
    hideModalError();
    document.getElementById('modalOverlay').classList.add('open');
    document.getElementById('fieldName').focus();
  }

  function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }
  function showModalError(msg) { const el = document.getElementById('modalError'); el.textContent = msg; el.classList.add('visible'); }
  function hideModalError()    { document.getElementById('modalError').classList.remove('visible'); }

  async function saveSchool() {
    const name  = document.getElementById('fieldName').value.trim();
    const type  = document.getElementById('fieldType').value;
    const city  = document.getElementById('fieldCity').value.trim();
    if (!name || !type || !city) { showModalError('Name, type, and city are required.'); return; }

    const data = {
      name, type, city,
      status:     document.getElementById('fieldStatus').value,
      adminEmail: document.getElementById('fieldAdminEmail').value.trim(),
    };

    const btn = document.getElementById('saveBtn');
    btn.disabled = true; btn.textContent = 'Saving…';
    try {
      if (editingId) {
        await db.collection('schools').doc(editingId).update(data);
      } else {
        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        await db.collection('schools').add(data);
      }
      closeModal();
      await loadSchools();
    } catch (e) {
      showModalError(e.message);
    } finally {
      btn.disabled = false; btn.textContent = 'Save School';
    }
  }

  function esc(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
</script>
</body>
</html>
