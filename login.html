<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In — CentralHub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Lora:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'DM Sans', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background-color: #1c1c2e;
      background-image:
        radial-gradient(circle at 15% 40%, rgba(139, 92, 246, 0.10) 0%, transparent 55%),
        radial-gradient(circle at 85% 70%, rgba(8, 145, 178, 0.07) 0%, transparent 50%);
    }

    /* ===== Login Box ===== */
    .login-box {
      background: #26263e;
      border-radius: 16px;
      padding: 48px 40px;
      width: 100%;
      max-width: 420px;
      box-shadow:
        0 20px 60px rgba(0, 0, 0, 0.45),
        0 0 0 1px rgba(255, 255, 255, 0.06);
      animation: slideUp 0.38s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(18px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ===== Brand ===== */
    .login-brand {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    .login-brand-name {
      font-size: 1.35rem;
      font-weight: 600;
      color: #ffffff;
      letter-spacing: -0.02em;
    }

    /* ===== Heading ===== */
    .login-title {
      font-family: 'Lora', serif;
      font-size: 1.55rem;
      font-weight: 600;
      color: #ffffff;
      text-align: center;
      margin-bottom: 6px;
    }

    .login-subtitle {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.42);
      text-align: center;
      margin-bottom: 30px;
    }

    /* ===== Error message ===== */
    .error-msg {
      display: none;
      background: rgba(239, 68, 68, 0.12);
      border: 1px solid rgba(239, 68, 68, 0.28);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 0.845rem;
      color: #fca5a5;
      margin-bottom: 16px;
      line-height: 1.45;
    }
    .error-msg.visible { display: block; }

    /* ===== Google button ===== */
    .btn-google {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
      padding: 12px 20px;
      background: #ffffff;
      color: #1c1c2e;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      font-weight: 500;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
      margin-bottom: 20px;
    }
    .btn-google:hover {
      background: #f0f0f0;
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    }
    .btn-google:active { transform: translateY(0); box-shadow: none; }
    .btn-google:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* ===== Divider ===== */
    .divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(255, 255, 255, 0.09);
    }
    .divider span {
      font-size: 0.78rem;
      color: rgba(255, 255, 255, 0.3);
      white-space: nowrap;
    }

    /* ===== Form fields ===== */
    .form-group { margin-bottom: 14px; }

    .form-label {
      display: block;
      font-size: 0.82rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.55);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 11px 14px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #ffffff;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    .form-input::placeholder { color: rgba(255, 255, 255, 0.22); }
    .form-input:focus {
      border-color: rgba(139, 92, 246, 0.55);
      background: rgba(255, 255, 255, 0.09);
    }

    /* ===== Sign-in button ===== */
    .btn-signin {
      width: 100%;
      padding: 12px 20px;
      background: linear-gradient(135deg, #7c3aed 0%, #0891b2 100%);
      color: #ffffff;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: opacity 0.2s ease, transform 0.15s ease;
      margin-top: 6px;
    }
    .btn-signin:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-signin:active { transform: translateY(0); }
    .btn-signin:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* ===== Domain note ===== */
    .domain-note {
      margin-top: 24px;
      text-align: center;
      font-size: 0.775rem;
      color: rgba(255, 255, 255, 0.22);
    }
    .domain-note code {
      font-family: 'DM Mono', monospace;
      color: rgba(139, 92, 246, 0.65);
    }

    /* ===== Responsive ===== */
    @media (max-width: 480px) {
      .login-box { padding: 36px 24px; }
    }
  </style>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;charset=utf-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%230a0a1a'/><polygon points='10,45 50,65 50,70 10,50' fill='%234e3db8'/><polygon points='90,45 50,65 50,70 90,50' fill='%235a4bd1'/><polygon points='50,25 90,45 50,65 10,45' fill='%236c5ce7'/><line x1='85' y1='46' x2='85' y2='68' stroke='%23ffd93d' stroke-width='4' stroke-linecap='round'/><circle cx='85' cy='72' r='3.5' fill='%23ffd93d'/></svg>">
</head>
<body>

<div class="login-box" role="main">

  <!-- Brand -->
  <div class="login-brand">
    <svg width="34" height="34" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <circle cx="16" cy="16" r="6" fill="#8b5cf6"/>
      <circle cx="16" cy="4.5" r="3.2" fill="#6d28d9" opacity="0.9"/>
      <circle cx="27.5" cy="22.5" r="3.2" fill="#6d28d9" opacity="0.9"/>
      <circle cx="4.5" cy="22.5" r="3.2" fill="#6d28d9" opacity="0.9"/>
      <line x1="16" y1="10" x2="16" y2="7.7" stroke="#c4b5fd" stroke-width="1.6" stroke-linecap="round"/>
      <line x1="21" y1="19.4" x2="24.7" y2="21.2" stroke="#c4b5fd" stroke-width="1.6" stroke-linecap="round"/>
      <line x1="11" y1="19.4" x2="7.3" y2="21.2" stroke="#c4b5fd" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
    <span class="login-brand-name">CentralHub</span>
  </div>

  <h1 class="login-title">Welcome back</h1>
  <p class="login-subtitle">Eduversal Indonesia — School Network Portal</p>

  <!-- Error -->
  <div class="error-msg" id="errorMsg" role="alert" aria-live="polite"></div>

  <!-- Google Sign-In -->
  <button class="btn-google" id="googleBtn" type="button" aria-label="Sign in with Google">
    <!-- Google colour logo -->
    <svg width="20" height="20" viewBox="0 0 48 48" aria-hidden="true">
      <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
      <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
      <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
      <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
    </svg>
    Sign in with Google
  </button>

  <div class="divider"><span>or sign in with email</span></div>

  <!-- Email/Password form -->
  <form id="emailForm" novalidate>
    <div class="form-group">
      <label class="form-label" for="emailInput">Email address</label>
      <input class="form-input" type="email" id="emailInput"
             placeholder="you@eduversal.org"
             autocomplete="email" required>
    </div>
    <div class="form-group">
      <label class="form-label" for="passwordInput">Password</label>
      <input class="form-input" type="password" id="passwordInput"
             placeholder="••••••••"
             autocomplete="current-password" required>
    </div>
    <button class="btn-signin" type="submit" id="signInBtn">Sign in</button>
  </form>

  <p class="domain-note">Access restricted to <code>@eduversal.org</code> accounts or authorised emails</p>

</div>

<script src="firebase-config.js"></script>
<script type="module">
  // ============================================================
  // login.html — Firebase auth (no auth-guard; this IS the guard)
  // ============================================================
  import { initializeApp }                                        from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, GoogleAuthProvider, onAuthStateChanged,
           signInWithPopup, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  const app  = initializeApp({
    apiKey:            window.ENV.FIREBASE_API_KEY,
    authDomain:        window.ENV.FIREBASE_AUTH_DOMAIN,
    projectId:         window.ENV.FIREBASE_PROJECT_ID,
    storageBucket:     window.ENV.FIREBASE_STORAGE_BUCKET,
    messagingSenderId: window.ENV.FIREBASE_MESSAGING_SENDER_ID,
    appId:             window.ENV.FIREBASE_APP_ID,
  });
  const auth = getAuth(app);

  const ALLOWED_DOMAINS = ['eduversal.org'];

  // Allowed if:
  //   • @eduversal.org domain, OR
  //   • signed in via email/password (= manually added in Firebase Console)
  // Google OAuth with a non-allowed domain is always rejected.
  function isAuthorized(user) {
    if (ALLOWED_DOMAINS.includes(user.email.split('@')[1])) return true;
    return user.providerData.some(p => p.providerId === 'password');
  }

  // If already signed in and authorized → go straight to dashboard
  onAuthStateChanged(auth, user => {
    const urlError = new URLSearchParams(location.search).get('error');
    if (urlError === 'domain' || urlError === 'access') {
      showError('Your account is not authorised. Contact your administrator to request access.');
    }
    if (user && isAuthorized(user)) {
      window.location.replace('index');
    }
  });

  // ----- Helpers -----
  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.classList.add('visible');
  }
  function hideError() {
    document.getElementById('errorMsg').classList.remove('visible');
  }

  const GOOGLE_ICON_SVG = `
    <svg width="20" height="20" viewBox="0 0 48 48" aria-hidden="true">
      <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
      <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
      <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
      <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
    </svg>`;

  // ----- Google Sign-In -----
  document.getElementById('googleBtn').addEventListener('click', async () => {
    hideError();
    const btn = document.getElementById('googleBtn');
    btn.disabled    = true;
    btn.textContent = 'Signing in…';

    const provider = new GoogleAuthProvider();
    // Hint Google to show only @eduversal.org accounts in the picker
    provider.setCustomParameters({ hd: 'eduversal.org' });

    try {
      const result = await signInWithPopup(auth, provider);
      if (!isAuthorized(result.user)) {
        await signOut(auth);
        showError('Your account is not authorised. Contact your administrator to request access.');
      } else {
        window.location.replace('index');
      }
    } catch (err) {
      if (err.code !== 'auth/popup-closed-by-user') {
        showError(err.message);
      }
    } finally {
      btn.disabled  = false;
      btn.innerHTML = GOOGLE_ICON_SVG + ' Sign in with Google';
    }
  });

  // ----- Email / Password Sign-In -----
  const ERROR_MESSAGES = {
    'auth/user-not-found':     'No account found with this email address.',
    'auth/wrong-password':     'Incorrect password. Please try again.',
    'auth/invalid-email':      'Please enter a valid email address.',
    'auth/invalid-credential': 'Invalid email or password.',
    'auth/too-many-requests':  'Too many failed attempts. Please wait and try again.',
    'auth/user-disabled':      'This account has been disabled.',
  };

  document.getElementById('emailForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();

    const email    = document.getElementById('emailInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    const btn      = document.getElementById('signInBtn');

    btn.disabled    = true;
    btn.textContent = 'Signing in…';

    try {
      // Email/password: if Firebase Auth accepts the credentials,
      // the user was manually added → authorize them directly.
      await signInWithEmailAndPassword(auth, email, password);
      window.location.replace('index');
    } catch (err) {
      showError(ERROR_MESSAGES[err.code] || err.message);
    } finally {
      btn.disabled    = false;
      btn.textContent = 'Sign in';
    }
  });
</script>

</body>
</html>
